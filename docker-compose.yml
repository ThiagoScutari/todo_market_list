services:
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: always
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.le.acme.tlschallenge=true"
      - "--certificatesresolvers.le.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.le.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./letsencrypt:/letsencrypt"
    networks:
      app_network:
        ipv4_address: 172.24.0.10
  redis:
    image: redis:6-alpine
    container_name: redis
    restart: always
    environment:
      - TZ=America/Sao_Paulo
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      app_network:
        ipv4_address: 172.24.0.11

  postgres:
    image: postgres:15
    container_name: postgres
    restart: always
    environment:
      - POSTGRES_USER=${N8N_DB_USER}
      - POSTGRES_PASSWORD=${N8N_DB_PASSWORD}
      - POSTGRES_DB=db_n8n
      - TZ=America/Sao_Paulo
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${N8N_DB_USER} -d db_n8n"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      app_network:
        ipv4_address: 172.24.0.12

  n8n-main:
    image: n8nio/n8n
    container_name: n8n-main
    restart: always
    environment:
      - N8N_METRICS=true
      - N8N_METRICS_INCLUDE_TIMER=true
      - N8N_METRICS_PREFIX=n8n_
      - N8N_HOST=n8n.thiagoscutari.com.br
      - N8N_DEFAULT_CORS=FALSE
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_RUNNERS_ENABLED=true
      - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true
      - NODE_ENV=production
      - WEBHOOK_URL=https://n8n.thiagoscutari.com.br/
      - N8N_SECURE_COOKIE=false
      - N8N_LOG_LEVEL=info
      - N8N_DEPLOYMENT_TYPE=main
      - EXECUTIONS_MODE=queue
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=db_n8n
      - DB_POSTGRESDB_USER=${N8N_DB_USER}
      - DB_POSTGRESDB_PASSWORD=${N8N_DB_PASSWORD}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - GENERIC_TIMEZONE=America/Sao_Paulo
      - TZ=America/Sao_Paulo
    volumes:
      - ./n8n_data:/home/node/.n8n
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`n8n.thiagoscutari.com.br`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls.certresolver=le"
      - "traefik.http.routers.n8n-ip.rule=Host(`162.240.102.45`)"
      - "traefik.http.routers.n8n-ip.entrypoints=web"
      - "traefik.http.routers.n8n-ip.priority=10"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
      - "traefik.http.middlewares.n8n.headers.accesscontrolallowmethods=GET,OPTIONS,PUT"
      - "traefik.http.middlewares.n8n.headers.accesscontrolallowheaders=*"
      - "traefik.http.middlewares.n8n.headers.accesscontrolalloworiginlist=*"
      - "traefik.http.middlewares.n8n.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.n8n.headers.addvaryheader=true"
    depends_on:
      - redis
      - postgres
    networks:
      app_network:
        ipv4_address: 172.24.0.13

  n8n-worker:
    image: n8nio/n8n
    container_name: n8n-main-worker
    restart: always
    environment:
      - NODE_ENV=production
      - N8N_DEPLOYMENT_TYPE=worker
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_RUNNERS_ENABLED=true
      - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true
      - EXECUTIONS_MODE=queue
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=db_n8n
      - DB_POSTGRESDB_USER=${N8N_DB_USER}
      - DB_POSTGRESDB_PASSWORD=${N8N_DB_PASSWORD}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - QUEUE_HEALTH_CHECK_ACTIVE=true
      - GENERIC_TIMEZONE=America/Sao_Paulo
      - TZ=America/Sao_Paulo
    volumes:
      - ./n8n_data_workers:/home/node/.n8n
    depends_on:
      - redis
      - postgres
    networks:
      app_network:
        ipv4_address: 172.24.0.14
    entrypoint: "n8n worker"

  # --- BANCO DE DADOS FAMILYOS ---
  db:
    image: postgres:15-alpine
    container_name: familyos_db
    restart: always
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME}
      - TZ=America/Sao_Paulo
    volumes:
      - ./familyos/postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      app_network:
        ipv4_address: 172.24.0.20

  # --- APLICAÇÃO FAMILYOS ---
  familyos-app:
    container_name: familyos_app
    build: ./familyos
    restart: always
    # ATENÇÃO: Mudamos para run:app
    command: gunicorn -w 1 -b 0.0.0.0:5000 --access-logfile - --error-logfile - --log-level info run:app
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - DATABASE_URL=${DATABASE_URL}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}      
      - TZ=America/Sao_Paulo
    volumes:
      - ./familyos:/app
    networks:
      app_network:
        aliases:
          - familyos-app
    depends_on:
      db:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.familyos.rule=Host(`api.thiagoscutari.com.br`)"
      - "traefik.http.routers.familyos.entrypoints=websecure"
      - "traefik.http.routers.familyos.tls.certresolver=le"
      - "traefik.http.services.familyos.loadbalancer.server.port=5000"

networks:
  app_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.24.0.0/16
          gateway: 172.24.0.1