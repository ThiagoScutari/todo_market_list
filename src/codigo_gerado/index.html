<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Lista de Compras</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <header>
        <h1>Minha Lista de Compras</h1>
        <button onclick="clearCart()" class="clear-cart-button">Limpar Carrinho</button>
    </header>
    <main>
        <section class="input-section">
            <input type="text" id="itemInput" placeholder="Adicionar item ou falar...">
            <button onclick="addItem()">Adicionar</button>
            <button onclick="startVoiceRecognition()">Voz</button>
        </section>

        <section class="list-section">
            {% if categorias %}
                {% for categoria_nome, itens_categoria in categorias.items() %}
                    <div class="category-group">
                        <h2>{{ categoria_nome }}</h2>
                        <ul>
                            {% for item in itens_categoria %}
                                <li class="list-item {% if item.status == 'comprado' %}item-comprado{% endif %}">
                                    <input type="checkbox" 
                                           id="item-{{ item.id }}" 
                                           {% if item.status == 'comprado' %}checked{% endif %}
                                           onclick="toggleItemStatus({{ item.id }})">
                                    <label for="item-{{ item.id }}">
                                        <span class="product-info">{{ item.nome }} ({{ item.detalhes }})</span>
                                        {% if item.usuario %}<span class="item-usuario"> - {{ item.usuario }}</span>{% endif %}
                                    </label>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endfor %}
            {% else %}
                <p>Sua lista de compras está vazia!</p>
            {% endif %}
        </section>
    </main>

    <script>
        function toggleItemStatus(itemId) {
            fetch(`/toggle_item/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const listItem = document.querySelector(`#item-${itemId}`).closest('.list-item');
                    if (data.novo_status === 'comprado') {
                        listItem.classList.add('item-comprado');
                    } else {
                        listItem.classList.remove('item-comprado');
                    }
                } else {
                    alert('Erro ao atualizar item: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro de comunicação com o servidor.');
            });
        }

        function clearCart() {
            if (confirm('Deseja excluir os itens marcados como comprados?')) {
                fetch('/clear_cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        window.location.reload();
                    } else {
                        alert('Erro ao limpar carrinho: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro de comunicação com o servidor ao limpar o carrinho.');
                });
            }
        }

        // Funções para adicionar item e reconhecimento de voz (mantidas do original, se existiam)
        function addItem() {
            const itemInput = document.getElementById('itemInput');
            const texto = itemInput.value.trim();
            if (!texto) return;

            fetch('/magic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ texto: texto, usuario: 'Web' }) // Assumindo usuário 'Web'
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    itemInput.value = '';
                    window.location.reload();
                } else if (data.erro) {
                    alert('Erro: ' + data.erro);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro de comunicação com o servidor.');
            });
        }

        let recognition;
        function startVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Seu navegador não suporta reconhecimento de voz.');
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('itemInput').value = transcript;
                addItem(); // Adiciona o item automaticamente após o reconhecimento
            };

            recognition.onerror = function(event) {
                console.error('Erro no reconhecimento de voz:', event.error);
                alert('Erro no reconhecimento de voz: ' + event.error);
            };

            recognition.onend = function() {
                console.log('Reconhecimento de voz finalizado.');
            };

            recognition.start();
            alert('Ouvindo...');
        }
    </script>
</body>
</html>