{% extends "base.html" %}

{% block title %}Lembretes - FamilyOS{% endblock %}

{% block content %}
    <div class="category-section">
        <div class="category-header" style="border-left-color: #ffb800;">
            <span><i class="bi bi-google"></i> Google Tasks</span>
            <span style="opacity:0.5; font-size:0.8em">({{ tasks|length }})</span>
        </div>
        
        <div class="product-list">
            {% if not tasks %}
                <div style="padding:20px; text-align:center; color:rgba(255,255,255,0.3);">
                    <i class="bi bi-calendar-x" style="font-size: 2rem;"></i>
                    <p>Nenhum lembrete pendente.</p>
                </div>
            {% endif %}

            {% for task in tasks %}
            <div class="product-card" id="reminder-{{ task.id }}" 
                 data-id="{{ task.id }}"
                 data-google-id="{{ task.google_id }}"
                 style="align-items: flex-start;">
                
                <div class="product-info" style="width: 100%;">
                    
                    {% if task.due_date %}
                    <div style="margin-bottom: 5px;">
                        <span class="date-badge" style="font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; background: rgba(255, 184, 0, 0.15); color: #ffb800; border: 1px solid rgba(255, 184, 0, 0.3);">
                            <i class="bi bi-calendar-event"></i> {{ task.due_date.strftime('%d/%m/%Y') }}
                            {% if task.due_date.strftime('%H:%M') != '00:00' %}
                                <i class="bi bi-clock" style="margin-left:5px"></i> {{ task.due_date.strftime('%H:%M') }}
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}

                    <div class="product-name" style="font-size: 1.1rem; margin-bottom: 5px;">
                        {{ task.title }}
                    </div>

                    <div class="task-notes" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px; border-left: 2px solid rgba(255,255,255,0.1); padding-left: 8px; display: {% if task.notes %}block{% else %}none{% endif %};">
                        {{ task.notes }}
                    </div>

                    {% if task.webViewLink %}
                    <a href="{{ task.webViewLink }}" target="_blank" style="text-decoration: none; font-size: 0.85rem; color: var(--neon-p); display: inline-flex; align-items: center; gap: 5px; margin-top: 8px;">
                        <i class="bi bi-box-arrow-up-right"></i> Abrir no Google
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div style="height: 20px;"></div>
    <button class="btn-clear-large" onclick="syncGoogle()" style="border-color:#ffb800; color:#ffb800; background:rgba(255, 184, 0, 0.1);">
        <i class="bi bi-arrow-repeat"></i> Sincronizar Agora
    </button>
    <div style="height: 80px;"></div>

    <div id="editReminderModal" class="modal-overlay">
        <div class="modal-box">
            <h3>EDITAR LEMBRETE</h3>
            <form id="editReminderForm">
                <input type="hidden" id="rid">
                <input type="hidden" id="rgoogleid">
                
                <label>O que lembrar?</label>
                <input type="text" id="rtitle" required autocomplete="off">
                
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label>Data</label>
                        <input type="date" id="rdate" style="color-scheme: dark;">
                    </div>
                    <div style="flex: 1;">
                        <label>Hora</label>
                        <input type="time" id="rtime" style="color-scheme: dark;">
                    </div>
                </div>

                <label>Detalhes / Notas</label>
                <textarea id="rnotes" rows="3" style="width: 100%; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 12px; color: white; font-size: 1rem; margin-bottom: 20px; outline: none; box-sizing: border-box; font-family: 'Inter', sans-serif;"></textarea>

                <button type="submit" class="btn-save" style="background: #ffb800;">SALVAR</button>
                <button type="button" class="btn-cancel" onclick="document.getElementById('editReminderModal').classList.remove('visible')">Cancelar</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    function syncGoogle() {
        const btn = document.querySelector('.btn-clear-large');
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Sincronizando...';
        // Simula reload (o sync real é backend)
        setTimeout(() => location.reload(), 1500);
    }

    // --- LONG PRESS EDIT ---
    let pressTimer;
    const cards = document.querySelectorAll('.product-card');

    cards.forEach(card => {
        const start = () => {
            pressTimer = setTimeout(() => {
                openReminderModal(card);
                if (navigator.vibrate) navigator.vibrate(100);
            }, 800);
        };
        const end = () => clearTimeout(pressTimer);

        card.addEventListener('mousedown', start);
        card.addEventListener('touchstart', start, {passive: true});
        card.addEventListener('mouseup', end);
        card.addEventListener('touchend', end);
        card.addEventListener('touchmove', end);
    });

    function openReminderModal(card) {
        const id = card.dataset.id;
        const googleId = card.dataset.googleId;
        const title = card.querySelector('.product-name').innerText;
        const notes = card.querySelector('.task-notes').innerText;
        
        // Tenta extrair data do badge (se existir)
        const dateBadge = card.querySelector('.date-badge');
        let dateVal = '';
        let timeVal = '';
        
        if (dateBadge) {
            const text = dateBadge.innerText; // Ex: 06/12/2025 14:00
            const parts = text.split(' ');
            if (parts.length > 0) {
                // Converte DD/MM/YYYY para YYYY-MM-DD
                const d = parts[0].split('/');
                if(d.length === 3) dateVal = `${d[2]}-${d[1]}-${d[0]}`;
            }
            if (parts.length > 1) {
                timeVal = parts[1];
            }
        }

        document.getElementById('rid').value = id;
        document.getElementById('rgoogleid').value = googleId;
        document.getElementById('rtitle').value = title;
        document.getElementById('rnotes').value = notes;
        document.getElementById('rdate').value = dateVal;
        document.getElementById('rtime').value = timeVal;

        document.getElementById('editReminderModal').classList.add('visible');
    }

    // SALVAR
    document.getElementById('editReminderForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('.btn-save');
        btn.innerText = "Sincronizando...";

        const data = {
            id: document.getElementById('rid').value,
            google_id: document.getElementById('rgoogleid').value,
            title: document.getElementById('rtitle').value,
            notes: document.getElementById('rnotes').value,
            date: document.getElementById('rdate').value,
            time: document.getElementById('rtime').value
        };

        try {
            const res = await fetch('/reminders/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if(res.ok) location.reload();
            else alert('Erro ao salvar');
        } catch (err) {
            console.error(err);
            alert('Erro de conexão');
        }
    };
</script>
{% endblock %}