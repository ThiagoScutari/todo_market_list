<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FamilyOS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <header>
        <h1><i class="bi bi-cart3"></i> FamilyOS</h1>
        {% if current_user.is_authenticated %}
        <div class="user-controls">
            <span class="welcome-text">Olá, {{ current_user.username }}</span>
            <a href="{{ url_for('logout') }}" class="btn-logout"><i class="bi bi-box-arrow-right"></i></a>
        </div>
        {% endif %}
    </header>

    <div class="container main-content">
        {% if not categorias %}
            <div class="empty-state">
                <i class="bi bi-basket"></i>
                <p class="mt-3">Sua lista está vazia.<br>Mande um áudio no Telegram!</p>
            </div>
        {% endif %}

        {% for categoria, itens in categorias.items() %}
            {% set cat_lower = categoria.lower() %}
            {% set color_class = 'purple' %} 
            {% if 'horti' in cat_lower or 'fruta' in cat_lower or 'legume' in cat_lower %}
                {% set color_class = 'green' %}
            {% elif 'carne' in cat_lower or 'açougue' in cat_lower or 'churrasco' in cat_lower %}
                {% set color_class = 'red' %}
            {% elif 'limpeza' in cat_lower or 'higiene' in cat_lower or 'frio' in cat_lower %}
                {% set color_class = 'blue' %}
            {% elif 'padaria' in cat_lower or 'café' in cat_lower %}
                {% set color_class = 'gold' %}
            {% endif %}

        <div class="category-section">
            <div class="category-header" onclick="toggleCategory(this)" data-color="{{ color_class }}">
                <span class="cat-title">{{ categoria }} <span style="opacity:0.5; font-size:0.8em; margin-left:5px">({{ itens|length }})</span></span>
                <i class="bi bi-chevron-down toggle-icon"></i>
            </div>
            
            <div class="product-list">
                {% for item in itens %}
                <div class="product-card {% if item.status == 'comprado' %}checked{% endif %}" id="card-{{ item.id }}">
                    <div class="product-info">
                        <!-- Aqui entra o EMOJI dinâmico -->
                        <div class="product-name"><span class="emoji-icon">{{ item.emoji }}</span> {{ item.nome }}</div>
                        <div class="product-meta">
                            {{ item.detalhes }} 
                            {% if item.usuario %} 
                                <span class="user-badge"><i class="bi bi-person-fill"></i> {{ item.usuario }}</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="product-checkbox">
                        <input type="checkbox" id="item-{{ item.id }}" 
                               onchange="toggleItem({{ item.id }})"
                               {% if item.status == 'comprado' %}checked{% endif %}>
                        <label for="item-{{ item.id }}"></label>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    {% if categorias %}
    <footer>
        <button class="btn-clear-large" onclick="clearCart()">
            <i class="bi bi-trash"></i> Limpar Carrinho
        </button>
    </footer>
    {% endif %}

    <script>
        function toggleCategory(header) {
            header.classList.toggle('closed');
            const lista = header.nextElementSibling;
            
            if (lista.style.display === "none") {
                lista.style.display = "block";
                header.querySelector('.toggle-icon').style.transform = "rotate(0deg)";
            } else {
                lista.style.display = "none";
                header.querySelector('.toggle-icon').style.transform = "rotate(-90deg)";
            }
        }

        function toggleItem(itemId) {
            const card = document.getElementById(`card-${itemId}`);
            card.classList.toggle('checked');
            
            if (navigator.vibrate) navigator.vibrate(50);

            fetch(`/toggle_item/${itemId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            }).then(res => res.json())
              .then(data => { 
                  if(data.status !== 'success') card.classList.toggle('checked'); 
              });
        }

        function clearCart() {
            if (confirm('Deseja excluir os itens marcados?')) {
                fetch('/clear_cart', { method: 'POST' })
                .then(() => window.location.reload());
            }
        }
    </script>
</body>
</html>