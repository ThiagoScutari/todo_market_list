<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lista de Compras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <header>
        <h1><i class="bi bi-cart3"></i> Lista de Compras</h1>
    </header>

    <div class="container main-content">
        {% if not categorias %}
            <div class="empty-state">
                <i class="bi bi-basket display-1 text-muted"></i>
                <p class="mt-3 text-muted">Sua lista está vazia.<br>Mande um áudio no Telegram!</p>
            </div>
        {% endif %}

        {% for categoria, itens in categorias.items() %}
        <div class="category-section">
            <div class="category-header active" onclick="toggleCategory(this)">
                <span class="cat-title">{{ categoria }} ({{ itens|length }})</span>
                <i class="bi bi-chevron-down toggle-icon"></i>
            </div>
            
            <div class="product-list active">
                {% for item in itens %}
                <div class="product-card {% if item.status == 'comprado' %}checked{% endif %}" id="card-{{ item.id }}">
                    <div class="product-info">
                        <div class="product-name">{{ item.nome }}</div>
                        <div class="product-meta">
                            {{ item.detalhes }} 
                            {% if item.usuario %} 
                                <span class="separator">•</span> 
                                <span class="user-name"><i class="bi bi-person-fill"></i> {{ item.usuario }}</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="product-checkbox">
                        <input type="checkbox" id="item-{{ item.id }}" 
                               onchange="toggleItem({{ item.id }})"
                               {% if item.status == 'comprado' %}checked{% endif %}>
                        <label for="item-{{ item.id }}"></label>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    {% if categorias %}
    <footer>
        <button class="btn-clear-large" onclick="clearCart()">
            Limpar Carrinho
        </button>
    </footer>
    {% endif %}

    <script>
        function toggleCategory(header) {
            header.classList.toggle('active');
            const lista = header.nextElementSibling;
            if (lista.style.display === "none") {
                lista.style.display = "block";
            } else {
                lista.style.display = "none";
            }
            // Animação da setinha
            const icon = header.querySelector('.toggle-icon');
            icon.style.transform = lista.style.display === "none" ? "rotate(0deg)" : "rotate(180deg)";
        }

        function toggleItem(itemId) {
            const card = document.getElementById(`card-${itemId}`);
            card.classList.toggle('checked');
            fetch(`/toggle_item/${itemId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            }).then(res => res.json())
              .then(data => { if(data.status !== 'success') card.classList.toggle('checked'); });
        }

        function clearCart() {
            if (confirm('Deseja excluir os itens marcados?')) {
                fetch('/clear_cart', { method: 'POST' })
                .then(() => window.location.reload());
            }
        }
    </script>
</body>
</html>