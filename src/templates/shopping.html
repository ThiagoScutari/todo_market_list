{% extends "base.html" %}

{% block title %}Mercado - FamilyOS{% endblock %}

{% block content %}
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div style="background: rgba(255,49,49,0.2); color:#ff3131; padding:10px; border-radius:8px; margin-bottom:15px; text-align:center; border:1px solid #ff3131;">
                {{ messages[0] }}
            </div>
        {% endif %}
    {% endwith %}

    {% if not categorias %}
        <div style="text-align: center; margin-top: 80px; color: var(--text-secondary);">
            <i class="bi bi-basket" style="font-size: 4rem; opacity: 0.2;"></i>
            <p style="margin-top:20px">Sua lista está vazia.<br>Mande um áudio no Telegram!</p>
        </div>
    {% endif %}

    {% for cat, itens in categorias.items() %}
    <div class="category-section">
        <div class="category-header" onclick="toggleSection(this)">
            {{ cat }} <span style="opacity:0.5; font-size:0.8em; margin-left:5px">({{ itens|length }})</span>
            <i class="bi bi-chevron-down" style="float:right; font-size:0.8em; margin-top:2px"></i>
        </div>
        
        <div class="product-list">
            {% for item in itens %}
            <div class="product-card {% if item.status == 'comprado' %}checked{% endif %}" 
                 id="card-{{ item.id }}" 
                 data-id="{{ item.id }}">
                
                <div class="product-info">
                    <div class="product-name"><span class="emoji">{{ item.emoji }}</span> {{ item.nome }}</div>
                    <div class="product-meta">
                        {{ item.detalhes }} • <i class="bi bi-person-fill"></i> {{ item.usuario }}
                    </div>
                </div>

                <div class="checkbox-wrapper">
                    <input type="checkbox" id="check-{{ item.id }}" 
                           onchange="toggleItem(this, {{ item.id }})" 
                           {% if item.status == 'comprado' %}checked{% endif %}>
                    <label for="check-{{ item.id }}"></label>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}

    {% if categorias %}
    <div style="height: 20px;"></div>
    <button class="btn-clear-large" onclick="clearCart()">
        <i class="bi bi-trash"></i> Arquivar Comprados
    </button>
    {% endif %}

    <div id="editModal" class="modal-overlay">
        <div class="modal-content-glass">
            <h3 style="margin-top:0; text-align:center;">EDITAR ITEM</h3>
            <form id="editForm">
                <input type="hidden" id="eid">
                
                <label>Nome</label>
                <input type="text" id="enome" autocomplete="off">
                
                <label>Categoria</label>
                <input type="text" id="ecat" list="catList" autocomplete="off" placeholder="Selecione ou digite..."
                       onmousedown="if(this.value === ''){this.value=' ';this.value='';}"
                       onclick="this.focus();">
                
                <datalist id="catList">
                    {% for cat in categorias.keys() %}
                    <option value="{{ cat }}">
                    {% endfor %}
                </datalist>

                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button type="button" class="btn-glass-cancel" style="flex:1; background:transparent; border:1px solid #555; color:#aaa; padding:12px; border-radius:8px;" onclick="document.getElementById('editModal').classList.remove('visible')">Cancelar</button>
                    <button type="submit" class="btn-glass-save" style="flex:1;">SALVAR</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Recolher Categorias
    function toggleSection(header) {
        const lista = header.nextElementSibling;
        lista.style.display = lista.style.display === 'none' ? 'block' : 'none';
        const icon = header.querySelector('.bi-chevron-down');
        icon.style.transform = lista.style.display === 'none' ? 'rotate(-90deg)' : 'rotate(0deg)';
    }

    // Marcar/Desmarcar (Optimistic UI)
    function toggleItem(checkbox, id) {
        const card = document.getElementById('card-' + id);
        if (checkbox.checked) {
            card.classList.add('checked');
            if (navigator.vibrate) navigator.vibrate(50);
        } else {
            card.classList.remove('checked');
        }
        fetch('/toggle_item/' + id, { method: 'POST' });
    }

    // Limpar Carrinho
    function clearCart() {
        if (confirm('Arquivar itens comprados?')) {
            fetch('/clear_cart', { method: 'POST' }).then(() => location.reload());
        }
    }

    // Long Press Logic (800ms)
    let pressTimer;
    const cards = document.querySelectorAll('.product-card');

    cards.forEach(card => {
        const start = (e) => {
            if (e.target.closest('.checkbox-wrapper')) return;
            pressTimer = setTimeout(() => {
                openModal(card);
                if (navigator.vibrate) navigator.vibrate(100);
            }, 800);
        };
        const end = () => clearTimeout(pressTimer);

        card.addEventListener('mousedown', start);
        card.addEventListener('touchstart', start, {passive: true});
        card.addEventListener('mouseup', end);
        card.addEventListener('touchend', end);
        card.addEventListener('mouseleave', end);
        card.addEventListener('touchmove', end);
    });

    function openModal(card) {
        const id = card.dataset.id;
        const fullText = card.querySelector('.product-name').innerText; 
        const nome = fullText.replace(/^[^\w\sÀ-ÿ]+/, '').trim(); // Remove emoji
        const cat = card.closest('.category-section').querySelector('.category-header').innerText.split('(')[0].trim();

        document.getElementById('eid').value = id;
        document.getElementById('enome').value = nome;
        document.getElementById('ecat').value = cat;
        document.getElementById('editModal').classList.add('visible');
    }

    document.getElementById('editForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        btn.innerHTML = "Salvando...";
        
        const data = {
            id: document.getElementById('eid').value,
            nome: document.getElementById('enome').value,
            categoria: document.getElementById('ecat').value
        };
        
        await fetch('/update_item', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        location.reload();
    };
</script>
{% endblock %}