{% extends "base.html" %}

{% block title %}Tarefas - FamilyOS{% endblock %}

{% block content %}
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div style="background: rgba(34, 255, 122, 0.1); color:#22ff7a; padding:10px; border-radius:8px; margin-bottom:15px; text-align:center; border:1px solid #22ff7a;">
                {{ messages[0] }}
            </div>
        {% endif %}
    {% endwith %}

    {% for responsavel, lista_tarefas in tasks.items() %}
    <div class="category-section">
        <div class="category-header" onclick="toggleSection(this)" 
             style="border-left-color: {% if responsavel == 'Casal' %}#ffb800{% else %}#611af0{% endif %}">
            <span style="display:flex; align-items:center; gap:8px;">
                {% if responsavel == 'Casal' %}<i class="bi bi-people-fill"></i>
                {% else %}<i class="bi bi-person-fill"></i>{% endif %}
                {{ responsavel }}
            </span>
            <span style="opacity:0.5; font-size:0.8em">({{ lista_tarefas|length }})</span>
        </div>
        
        <div class="product-list">
            {% if not lista_tarefas %}
                <div style="padding:15px; text-align:center; color:rgba(255,255,255,0.3); font-size:0.9rem;">
                    Nada pendente.
                </div>
            {% endif %}

            {% for task in lista_tarefas %}
            <div class="product-card {% if task.status == 'concluido' %}checked{% endif %}" 
                 id="task-{{ task.id }}">
                
                <div class="product-info">
                    <div class="product-name" style="display:flex; align-items:center; gap:8px;">
                        {{ task.descricao }}
                        
                        {% if task.prioridade == 3 %}
                            <span title="Alta Prioridade" style="width:8px; height:8px; background:#ff3131; border-radius:50%; box-shadow:0 0 5px #ff3131;"></span>
                        {% elif task.prioridade == 2 %}
                            <span title="MÃ©dia Prioridade" style="width:8px; height:8px; background:#ffb800; border-radius:50%;"></span>
                        {% endif %}
                    </div>
                    <div class="product-meta">
                        {{ task.created_at.strftime('%d/%m') }} â€¢ 
                        <span style="color: {% if task.prioridade == 3 %}#ff3131{% else %}inherit{% endif %}">
                            {% if task.prioridade == 3 %}Urgente{% elif task.prioridade == 2 %}Importante{% else %}Normal{% endif %}
                        </span>
                    </div>
                </div>

                <div class="checkbox-wrapper">
                    <input type="checkbox" id="check-task-{{ task.id }}" 
                           onchange="toggleTask(this, {{ task.id }})"
                           {% if task.status == 'concluido' %}checked{% endif %}>
                    <label for="check-task-{{ task.id }}"></label>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}

    <div style="height: 20px;"></div>
    <button class="btn-clear-large" onclick="clearTasks()">
        <i class="bi bi-check2-all"></i> Arquivar ConcluÃ­das
    </button>
    <div style="height: 80px;"></div>
    
    <div id="editTaskModal" class="modal-overlay">
        <div class="modal-box">
            <h3>EDITAR TAREFA</h3>
            <form id="editTaskForm">
                <input type="hidden" id="tid">
                
                <label>O que fazer?</label>
                <input type="text" id="tdesc" required autocomplete="off">
                
                <label>ResponsÃ¡vel pela tarefa?</label>
                <select id="tresp">
                    <option value="Thiago">Thiago</option>
                    <option value="Debora">Debora</option>
                    <option value="Casal">Casal</option>
                </select>

                <label>Prioridade</label>
                <select id="tprio">
                    <option value="1">ðŸŸ¢ Baixa (Normal)</option>
                    <option value="2">ðŸŸ¡ MÃ©dia (Importante)</option>
                    <option value="3">ðŸ”´ Alta (Urgente)</option>
                </select>

                <button type="submit" class="btn-save">SALVAR</button>
                <button type="button" class="btn-cancel" onclick="document.getElementById('editTaskModal').classList.remove('visible')">Cancelar</button>
            </form>
        </div>
    </div>

    {% endblock %}

{% block extra_js %}
<script>
    function toggleSection(header) {
        const lista = header.nextElementSibling;
        lista.style.display = lista.style.display === 'none' ? 'block' : 'none';
    }

    function toggleTask(checkbox, id) {
        const card = document.getElementById('task-' + id);
        
        if (checkbox.checked) {
            // Apenas risca, NÃƒO SOME MAIS
            card.classList.add('checked');
            if (navigator.vibrate) navigator.vibrate(50);
        } else {
            card.classList.remove('checked');
        }

        // Chama o Backend
        fetch('/toggle_task/' + id, { method: 'POST' });
    }

    function clearTasks() {
        if (confirm('Arquivar tarefas concluÃ­das?')) {
            fetch('/clear_tasks', { method: 'POST' }).then(() => location.reload());
        }
    }


// ... (cÃ³digo existente de toggle e clear) ...

    // LOGICA DE LONG PRESS (EDITAR)
    let pressTimer;
    const cards = document.querySelectorAll('.product-card');

    cards.forEach(card => {
        const start = (e) => {
            if (e.target.closest('.checkbox-wrapper')) return; // Ignora clique no check
            pressTimer = setTimeout(() => {
                openTaskModal(card);
                if (navigator.vibrate) navigator.vibrate(100);
            }, 800);
        };
        const end = () => clearTimeout(pressTimer);

        card.addEventListener('mousedown', start);
        card.addEventListener('touchstart', start, {passive: true});
        card.addEventListener('mouseup', end);
        card.addEventListener('touchend', end);
        card.addEventListener('touchmove', end);
    });
    function openTaskModal(card) {
        const id = card.id.replace('task-', '');
        
        // 1. Pega a descriÃ§Ã£o (texto da tarefa)
        // O seletor .product-name pega o texto, mas precisamos limpar espaÃ§os extras
        const descricaoElement = card.querySelector('.product-name');
        const descricao = descricaoElement.innerText.trim();

        // 2. Tenta descobrir quem Ã© o responsÃ¡vel atual para prÃ©-selecionar no modal
        // Buscamos a section pai para ver em qual accordion a tarefa estÃ¡
        const section = card.closest('.category-section');
        const headerText = section.querySelector('.category-header span').innerText;
        
        let responsavelAtual = "Thiago"; // Default
        if (headerText.includes("Debora")) responsavelAtual = "Debora";
        if (headerText.includes("Casal")) responsavelAtual = "Casal";

        // 3. Preenche o formulÃ¡rio
        document.getElementById('tid').value = id;
        document.getElementById('tdesc').value = descricao;
        document.getElementById('tresp').value = responsavelAtual;
        
        // Tenta adivinhar a prioridade pela cor da bolinha (opcional, ou deixa padrÃ£o 1)
        // (Se quiser implementar depois, precisaria salvar data-priority no card)
        
        // Abre o modal
        document.getElementById('editTaskModal').classList.add('visible');
    };
    // SALVAR EDIÃ‡ÃƒO
    document.getElementById('editTaskForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('.btn-save');
        btn.innerText = "Salvando...";

        const data = {
            id: document.getElementById('tid').value,
            descricao: document.getElementById('tdesc').value,
            responsavel: document.getElementById('tresp').value,
            prioridade: document.getElementById('tprio').value
        };

        await fetch('/tasks/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        location.reload();
    };
</script>
{% endblock %}