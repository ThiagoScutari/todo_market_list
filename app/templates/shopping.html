{% extends "base.html" %}

{% block title %}Mercado - FamilyOS{% endblock %}

{% block content %}
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div style="background: rgba(255,49,49,0.2); color:#ff3131; padding:10px; border-radius:8px; margin-bottom:15px; text-align:center; border:1px solid #ff3131;">
                {{ messages[0] }}
            </div>
        {% endif %}
    {% endwith %}

    {% if not categorias %}
        <div style="text-align: center; margin-top: 80px; color: var(--text-secondary);">
            <i class="bi bi-basket" style="font-size: 4rem; opacity: 0.2;"></i>
            <p style="margin-top:20px">Sua lista est√° vazia.<br>Use o bot√£o + para adicionar.</p>
        </div>
    {% endif %}

    {% for cat, itens in categorias.items() %}
    <div class="category-section">
        <div class="category-header" onclick="toggleSection(this)">
            {{ cat }} <span style="opacity:0.5; font-size:0.8em; margin-left:5px">({{ itens|length }})</span>
            <i class="bi bi-chevron-down" style="float:right; font-size:0.8em; margin-top:2px"></i>
        </div>
        
        <div class="product-list">
            {% for item in itens %}
            <div class="product-card {% if item.status == 'comprado' %}checked{% endif %}" 
                 id="card-{{ item.id }}" 
                 data-id="{{ item.id }}"
                 data-qty="{{ item.quantidade }}"> 
                
                <div class="product-info">
                    <div class="product-name">
                        {% if item.quantidade > 1 %}
                            <span style="color:var(--neon-g); font-size:0.9em; margin-right:4px;">{{ item.quantidade }}x</span>
                        {% endif %}
                        {{ item.emoji if item.emoji else 'üì¶' }} {{ item.nome }}
                    </div>

                    <div class="product-meta">
                        {{ item.detalhes }} ‚Ä¢ <i class="bi bi-person-fill"></i> {{ item.usuario }}
                    </div>
                </div>

                <div class="checkbox-wrapper">
                    <input type="checkbox" id="check-{{ item.id }}" 
                           onchange="toggleItem(this, {{ item.id }})" 
                           {% if item.status == 'comprado' %}checked{% endif %}>
                    <label for="check-{{ item.id }}"></label>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}

    <div style="height: 100px;"></div>

    <div class="fab-group">
        <button class="fab-btn add-btn" onclick="openAddModal()">
            <i class="bi bi-plus-lg"></i>
        </button>
        
        {% if categorias %}
        <button class="fab-btn archive-btn" onclick="clearCart()">
            <i class="bi bi-archive"></i>
        </button>
        {% endif %}
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modalTitle">EDITAR ITEM</h3>
            <form id="editForm">
                <input type="hidden" id="eid"> <label>O que precisamos?</label>
                <input type="text" id="enome" autocomplete="off" required placeholder="Ex: Leite, P√£o...">
                
                <label>Quantidade</label>
                <div class="qty-wrapper">
                    <button type="button" class="qty-btn" onclick="adjustQty(-1)">
                        <i class="bi bi-dash"></i>
                    </button>
                    
                    <input type="number" id="eqty" class="qty-input" value="1" min="1" inputmode="numeric">
                    
                    <button type="button" class="qty-btn" onclick="adjustQty(1)">
                        <i class="bi bi-plus"></i>
                    </button>
                </div>

                <button type="submit" class="btn-save">SALVAR</button>
                <button type="button" class="btn-cancel" onclick="document.getElementById('editModal').classList.remove('visible')">Cancelar</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Recolher Categorias
    function toggleSection(header) {
        const lista = header.nextElementSibling;
        lista.style.display = lista.style.display === 'none' ? 'block' : 'none';
        const icon = header.querySelector('.bi-chevron-down');
        icon.style.transform = lista.style.display === 'none' ? 'rotate(-90deg)' : 'rotate(0deg)';
    }

    // Marcar/Desmarcar
    function toggleItem(checkbox, id) {
        const card = document.getElementById('card-' + id);
        if (checkbox.checked) {
            card.classList.add('checked');
            if (navigator.vibrate) navigator.vibrate(50);
        } else {
            card.classList.remove('checked');
        }
        fetch('/toggle_item/' + id, { method: 'POST' });
    }

    // Limpar Carrinho
    function clearCart() {
        if (confirm('Arquivar itens comprados?')) {
            fetch('/clear_cart', { method: 'POST' }).then(() => location.reload());
        }
    }

    // --- LOGICA DO MODAL ---

    function adjustQty(delta) {
        const input = document.getElementById('eqty');
        let val = parseInt(input.value) || 1;
        val += delta;
        if (val < 1) val = 1;
        input.value = val;
    }

    function openAddModal() {
        document.getElementById('eid').value = ''; 
        document.getElementById('enome').value = '';
        document.getElementById('eqty').value = '1';
        
        document.getElementById('modalTitle').innerText = 'NOVO ITEM';
        document.getElementById('editModal').classList.add('visible');
        setTimeout(() => document.getElementById('enome').focus(), 100);
    }

    let pressTimer;
    const cards = document.querySelectorAll('.product-card');

    cards.forEach(card => {
        const start = (e) => {
            if (e.target.closest('.checkbox-wrapper')) return;
            pressTimer = setTimeout(() => {
                openEditModal(card);
                if (navigator.vibrate) navigator.vibrate(100);
            }, 800);
        };
        const end = () => clearTimeout(pressTimer);
        card.addEventListener('mousedown', start);
        card.addEventListener('touchstart', start, {passive: true});
        card.addEventListener('mouseup', end);
        card.addEventListener('touchend', end);
        card.addEventListener('mouseleave', end);
        card.addEventListener('touchmove', end);
    });

    function openEditModal(card) {
        const id = card.dataset.id;
        const qty = parseInt(card.dataset.qty) || 1; // Garante Inteiro
        
        // CORRE√á√ÉO DA DUPLICIDADE:
        // O product-name contem: "2x" (span) + "Emoji" + "Nome"
        // Vamos pegar APENAS o texto puro, ignorando spans e emojis
        
        // Clona o elemento para n√£o estragar o original e remove o span de qtd
        let cloneInfo = card.querySelector('.product-name').cloneNode(true);
        let spanQty = cloneInfo.querySelector('span'); // O span do '2x'
        if (spanQty && spanQty.innerText.includes('x')) {
            spanQty.remove();
        }

        let fullText = cloneInfo.innerText; 
        // Regex poderosa: Remove tudo que n√£o for letra/n√∫mero no come√ßo (emojis)
        // e faz trim.
        // Ex: "üì¶ Leite" -> "Leite"
        // Ex: "ü•õ Leite Integral" -> "Leite Integral"
        let nomeLimpo = fullText.replace(/^[^\w\s√Ä-√ø]+/, '').trim(); 

        document.getElementById('eid').value = id;
        document.getElementById('enome').value = nomeLimpo;
        document.getElementById('eqty').value = qty;
        
        document.getElementById('modalTitle').innerText = 'EDITAR ITEM';
        document.getElementById('editModal').classList.add('visible');
    }

    document.getElementById('editForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = "Salvando...";
        btn.disabled = true;
        
        const id = document.getElementById('eid').value;
        const nome = document.getElementById('enome').value;
        const qty = document.getElementById('eqty').value;

        try {
            let url = id ? '/update_item' : '/shopping/add';
            const body = JSON.stringify({ id: id, nome: nome, quantidade: qty });

            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: body
            });

            if (res.ok) {
                location.reload();
            } else {
                const err = await res.json();
                alert('Erro: ' + (err.error || 'Falha ao salvar'));
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        } catch (error) {
            console.error(error);
            alert('Erro de conex√£o');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    };
</script>
{% endblock %}